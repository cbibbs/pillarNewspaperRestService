var Datastore = require("nedb");
var spromise  = require("spromise");

var ready = spromise.defer();
var db = {}, currentId = 1;


db.counters = new Datastore({
  filename: "storage/counters.db",
  autoload: true,
  onload: function(err) {
    if ( err ) {
      ready.reject(err);
    }
    else {
      db.counters.findOne({"id": "seed"}, function(err, result) {
        if ( result && result.value ) {
          currentId = result.value;
        }
        else {
          db.counters.insert({"value": currentId, "id": "seed"}, function(){});
        }
      ready.resolve(db);
      });
    }
  }
});

db.counters.insert(
   {
      _id: "paperid",
      seq: 0
   }
);

function generateId() {
  currentId++;
  db.counters.update({"id": "seed"}, { $set: { "value": currentId } }, {}, function(){});
  return currentId;
}


db.counters.loadDatabase();
db.counters.ready = ready.promise;
module.exports = {
    ready: ready.promise,
    generateId: generateId
};

